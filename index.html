<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Golden Radio Hour – Marathon Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .card {
      background: #1b1b1b;
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
      border: 1px solid #333;
    }
    .shows-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 6px 14px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 6px;
    }
    label.show-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    label.show-item input {
      transform: scale(1.2);
    }
    .target-buttons button {
      margin: 4px 6px 4px 0;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .target-buttons button.active {
      border-color: #ffd54f;
      background: #333;
    }
    .actions {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .actions button {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      font-size: 0.95rem;
      cursor: pointer;
    }
    #buildBtn {
      background: #ffd54f;
      color: #111;
      font-weight: 600;
    }
    #clearBtn {
      background: #333;
      color: #eee;
    }
    #sendBtn {
      background: #4caf50;
      color: #111;
      font-weight: 600;
    }
    #playlistOutput {
      display: none; /* keep internal but invisible */
      width: 100%;
      min-height: 180px;
      background: #0d0d0d;
      color: #eee;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 10px;
      font-family: Consolas, Menlo, monospace;
      font-size: 0.9rem;
      resize: vertical;
    }
    .small {
      font-size: 0.8rem;
      color: #aaa;
    }
    .top-note {
      font-size: 0.85rem;
      color: #bbb;
      margin-bottom: 0.5rem;
    }
    #status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #ccc;
    }
    #senderName,
    #userTitle {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0d0d0d;
      color: #eee;
      font-size: 0.9rem;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Golden Radio Hour – Marathon Builder</h1>
    <div class="top-note">
      Choose your favorite shows, pick a marathon length, and send Wade a custom marathon request. He’ll build the final lineup from his full library.
    </div>

    <!-- 1. Show picker -->
    <div class="card">
      <h2>1. Choose Shows</h2>
      <div id="showsContainer" class="shows-grid"></div>
      <div class="small" style="margin-top:6px;">
        Select one or more shows you want included in your custom marathon.
      </div>
    </div>

    <!-- 2. Length picker -->
    <div class="card">
      <h2>2. Choose Target Length</h2>
      <div class="target-buttons">
        <button type="button" data-hours="3">3 hours</button>
        <button type="button" data-hours="6">6 hours</button>
        <button type="button" data-hours="9">9 hours</button>
        <button type="button" data-hours="12" class="active">12 hours</button>
      </div>
      <div class="small">
        The builder will try to get as close to this length as possible.
      </div>
    </div>

    <!-- 3. Sender + title + send -->
    <div class="card">
      <h2>3. Send Your Request</h2>

      <div class="small">Your name or nickname (optional):</div>
      <input id="senderName" type="text" placeholder="Example: Mary from Seattle" />

      <div class="small" style="margin-top:8px;">Your marathon title idea (optional):</div>
      <input id="userTitle" type="text" placeholder="Example: Frontier Trails & Fort Laramie Nights" />

      <div class="actions">
        <button id="buildBtn">Create My Marathon</button>
        <button id="clearBtn">Clear Selection</button>
        <button id="sendBtn">Send to Wade</button>
      </div>
      <div id="status"></div>

      <!-- Hidden playlist text (internal only) -->
      <textarea id="playlistOutput"></textarea>

      <div class="small">
        “Send to Wade” emails your request directly to him, including your show choices, target length, your title idea, and the internal playlist.
      </div>
    </div>
  </div>

  <!-- Hidden form for Formspree -->
  <form id="sendForm" action="https://formspree.io/f/mqarbnyg" method="POST" style="display:none;">
    <input type="hidden" name="playlist" id="playlistField">
    <input type="hidden" name="shows_selected" id="showsField">
    <input type="hidden" name="target_hours" id="hoursField">
    <input type="hidden" name="sender_name" id="senderNameField">
    <input type="hidden" name="user_title" id="userTitleField">
  </form>

  <script>
    let library = [];
    let targetSeconds = 12 * 3600;

    const showsContainer = document.getElementById("showsContainer");
    const playlistOutput = document.getElementById("playlistOutput");
    const statusElem = document.getElementById("status");

    const sendForm = document.getElementById("sendForm");
    const playlistField = document.getElementById("playlistField");
    const showsField = document.getElementById("showsField");
    const hoursField = document.getElementById("hoursField");
    const senderNameField = document.getElementById("senderNameField");
    const userTitleField = document.getElementById("userTitleField");

    function setStatus(msg) {
      statusElem.textContent = msg || "";
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function secondsToHMS(sec) {
      sec = Math.max(0, Math.floor(sec));
      const h = String(Math.floor(sec / 3600)).padStart(2, "0");
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
      const s = String(sec % 60).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function buildShowsUI() {
      // All unique show names from library.json, no duplicates, no blanks
      const set = new Set(
        library
          .map(e => e.show)
          .filter(show => show && show.trim() !== "")
      );
      const sorted = [...set].sort((a, b) => a.localeCompare(b));

      showsContainer.innerHTML = "";
      sorted.forEach(show => {
        const label = document.createElement("label");
        label.className = "show-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = show;

        const span = document.createElement("span");
        span.textContent = show;

        label.appendChild(cb);
        label.appendChild(span);
        showsContainer.appendChild(label);
      });
    }

    function getSelectedShows() {
      return Array.from(
        showsContainer.querySelectorAll("input[type=checkbox]:checked")
      ).map(cb => cb.value);
    }

    function buildMarathon() {
      const selectedShows = getSelectedShows();
      if (selectedShows.length === 0) {
        setStatus("Please select at least one show.");
        playlistOutput.value = "";
        return;
      }

      const pool = library.filter(ep => selectedShows.includes(ep.show));
      if (pool.length === 0) {
        setStatus("No episodes found for the selected shows.");
        playlistOutput.value = "";
        return;
      }

      shuffle(pool);

      const chosen = [];
      let total = 0;

      for (const ep of pool) {
        if (total + ep.duration_seconds > targetSeconds + 5 * 60) continue;
        chosen.push(ep);
        total += ep.duration_seconds;
        if (total >= targetSeconds) break;
      }

      if (chosen.length === 0) {
        setStatus("Could not fit any episodes into the selected length.");
        playlistOutput.value = "";
        return;
      }

      let out = "";
      let running = 0;
      chosen.forEach((ep, idx) => {
        const start = secondsToHMS(running);
        out += `${idx + 1}. ${start} ${ep.show} - ${ep.episode_title}\n`;
        running += ep.duration_seconds;
      });
      out += `\nTotal duration: ${secondsToHMS(running)}\n`;

      playlistOutput.value = out.trim();
      setStatus(`Marathon request created (~${secondsToHMS(running)}). Click "Send to Wade" to submit it.`);
    }

    // Target length buttons
    document.querySelectorAll(".target-buttons button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".target-buttons button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const hours = parseInt(btn.dataset.hours, 10) || 12;
        targetSeconds = hours * 3600;
      });
    });

    document.getElementById("buildBtn").addEventListener("click", buildMarathon);

    document.getElementById("clearBtn").addEventListener("click", () => {
      showsContainer.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      playlistOutput.value = "";
      setStatus("");
    });

    document.getElementById("sendBtn").addEventListener("click", () => {
      const text = playlistOutput.value.trim();
      if (!text) {
        setStatus("Nothing to send yet. Click 'Create My Marathon' first.");
        return;
      }

      const selectedShows = getSelectedShows();
      const activeBtn = document.querySelector(".target-buttons button.active");
      const hours = activeBtn ? activeBtn.dataset.hours : "12";
      const senderName = document.getElementById("senderName").value.trim();
      const userTitle = document.getElementById("userTitle").value.trim();

      playlistField.value = text;
      showsField.value = selectedShows.join(", ");
      hoursField.value = hours;
      senderNameField.value = senderName;
      userTitleField.value = userTitle;

      setStatus("Sending playlist to Wade...");
      sendForm.submit();
    });

    // Load library.json (built from your cleaned CSV)
    fetch("library.json")
      .then(r => r.json())
      .then(data => {
        library = data || [];
        setStatus(`Library loaded. Episodes available: ${library.length}`);
        buildShowsUI();
      })
      .catch(err => {
        console.error(err);
        setStatus("Error loading library.json. Make sure it’s in the same folder as this page.");
      });
  </script>
</body>
</html>
